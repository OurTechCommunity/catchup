name: Build and deploy web app
on:
    push:
        branches:
            - main
        paths:
            - ".github/workflows/build-deploy-web-app.yaml"
            - "public/**"
            - "summary/**"
            - "util/build.sh"
            - "index.js"
            - "package-lock.json"
            - "package.json"

    pull_request:
        branches:
            - main
        paths:
            - ".github/workflows/build-deploy-web-app.yaml"
            - "public/**"
            - "summary/**"
            - "util/build.sh"
            - "index.js"
            - "package-lock.json"
            - "package.json"

    workflow_dispatch: # Allows manual execution of workflow

jobs:
    build:
        if: startsWith(github.ref, 'refs/pull/')
        runs-on: ubuntu-latest
        container: "docker://asciidoctor/docker-asciidoctor:latest"
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Build Asciidoctor site
              run: |
                  chmod +x util/build.sh
                  ./util/build.sh

            - name: Remove unnecessary files
              run: rm -rf .github summary util .gitignore .prettierrc CONTRIBUTING.md LICENSE README.md sample.env

    build-and-deploy:
        if: startsWith(github.ref, 'refs/heads/')
        runs-on: ubuntu-latest
        container: "docker://asciidoctor/docker-asciidoctor:latest"
        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Build Asciidoctor site
              run: |
                  chmod +x util/build.sh
                  ./util/build.sh

            - name: Remove unnecessary files
              run: rm -rf .github summary util .gitignore .prettierrc CONTRIBUTING.md LICENSE README.md sample.env

            - name: Deploy to Deta
              uses: BogDAAAMN/deta-deploy-action@v1.0.1
              with:
                  deta-access-token: ${{ secrets.DETA_TOKEN }}
                  deta-name: catchup
                  deta-project: otc
                  deta-project-dir: "."
